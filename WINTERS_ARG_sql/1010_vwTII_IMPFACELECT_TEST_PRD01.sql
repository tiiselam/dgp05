USE [PRD01]
GO

/****** Object:  View [dbo].[vwTII_IMPFACELECT_TEST_PRD01]    Script Date: 28/8/2018 16:40:46 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE view [dbo].[vwTII_IMPFACELECT_TEST_PRD01] as
		SELECT 
		'SOP30200' stabla,
		SP302.SOPNUMBE												SOPNUMBE
		,	CONVERT(VARCHAR,SP302.DOCDATE,103)							DOCDATE
		,	SP302.SOPTYPE												SOPTYPE
		,	SP303.LNITMSEQ												LNITMSEQ
		,	SP302.CUSTNMBR												CUSTNMBR
		,	SP302.CUSTNAME												CUSTNAME
		,	RM102.ADDRESS1												ADDRESS1
		,	RM102.CITY													CITY
		,	RM102.STATE													PROVIN
		,	RM102.ZIP													ZIPCODE
		,	RM102.COUNTRY												COUNTRY
		,	SUBSTRING ( LEFT ( SP302.TXRGNNUM , 11 ) , 1 , 2 )
		+	'-'
		+	SUBSTRING ( LEFT ( SP302.TXRGNNUM , 11 ) , 3 , 8 )
		+	'-'
		+	SUBSTRING ( LEFT ( SP302.TXRGNNUM , 11 ) , 11 , 1 )			CUIT
		,	SP302.PHNUMBR1												PHONE
		,	SP302.PYMTRMID												PYMTRMID
		,	ISNULL ( 
						(
						SELECT	SY039.TXTFIELD 
						FROM	PRD01..SY03300 SY033 , 
								PRD01..SY03900 SY039 
						WHERE	SY033.PYMTRMID = SP302.PYMTRMID 
							AND SY039.NOTEINDX = SY033.NOTEINDX 
						) , '' 
					)													CONDVENTA
--		,	SP102.SERLTQTY												QUANTITY
		,	SP303.QUANTITY												QUANTITY
		,	RTRIM ( SP303.ITEMNMBR ) + ' - '
		+	RTRIM ( SP303.ITEMDESC )  									ITEMDESC
		,	/*RTRIM ( SP102.SERLTNUM )*/ ''								MATERIAL
		,	ISNULL	( 
						( 
						SELECT	SP603.CUSTITEMNMBR 
						FROM	PRD01..SOP60300 SP603 
						WHERE	SP603.ITEMNMBR = SP303.ITEMNMBR 
							AND SP603.CUSTNMBR = SP302.CUSTNMBR 
						) , '' 
					)
																		ITEMCLIE
		,	CASE WHEN SP302.ORIGNUMB <> '' AND SP302.SOPTYPE = 3 THEN ISNULL((SELECT TOP 1 ORG.ORIGNUMB FROM
			(SELECT ORIGNUMB FROM PRD01..SOP30200 X WHERE X.SOPTYPE = SP302.ORIGTYPE AND X.SOPNUMBE = SP302.ORIGNUMB
			UNION
			SELECT ORIGNUMB FROM PRD01..SOP10100 X WHERE X.SOPTYPE = SP302.ORIGTYPE AND X.SOPNUMBE = SP302.ORIGNUMB) ORG), '') 
			else
			SP302.ORIGNUMB END REMITO
--		,	CONVERT(VARCHAR,SP102.DATERECD,103)							FECHREMI
		,	CONVERT(VARCHAR,SP302.SALEDATE,103)							FECHREMI
		,	SP303.UNITPRCE												UNITPRCE
		,	SP303.ORUNTPRC												ORUNTPRC
		,	SP303.TRDISAMT												LTRDISAMT
		,	SP303.ORTDISAM												LORTDISAM
--		,	ROUND ( ( SP102.SERLTQTY * SP303.UNITPRCE ) , 4 )			XTNDPRCE
		,	ROUND ( ( SP303.XTNDPRCE) , 4 )								XTNDPRCE
--		,	ROUND ( ( SP102.SERLTQTY * SP303.ORUNTPRC ) , 4 )			OXTNDPRC
		,	ROUND ( ( SP303.OXTNDPRC) , 4 )								OXTNDPRC
		,	SP302.TRDISAMT												TTRDISAMT
		,	SP302.ORTDISAM												TORTDISAM
		,	'RESP.INSCRIPTO'											IMPTIT01
		,	CASE SUBSTRING(SP302.SOPNUMBE, 4, 1)
			WHEN 'A' THEN
				ISNULL	( 
							( 
							SELECT	SUM ( SP105.STAXAMNT ) 
							FROM	PRD01..SOP10105 SP105 
							WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
								AND SP105.SOPNUMBE = SP303.SOPNUMBE 
								AND SP105.LNITMSEQ = SP303.LNITMSEQ 
	--							AND SP105.TAXDTLID IN ('V-IVA 21','V-IVA 10.5') 
								AND SP105.TAXDTLID IN ('V-IVA 21') 
							) , 0 
						) 												
			ELSE
				ISNULL	( 
							( 
							SELECT	SUM ( SP105.STAXAMNT ) 
							FROM	PRD01..SOP10105 SP105 
							WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
								AND SP105.SOPNUMBE = SP303.SOPNUMBE 
								AND SP105.LNITMSEQ = SP303.LNITMSEQ 
	--							AND SP105.TAXDTLID IN ('V-IVA 21','V-IVA 10.5') 
								AND SP105.TAXDTLID IN ('V-IVA CONS FIN', 'V-IVA MONOT') 
							) , 0 
						) 												
			
			END															IMPVAL01
		,	'PERC.II.BB. BS.AS.'										IMPTIT02
		,	ISNULL	( 
						( 
						SELECT	SUM ( SP105.STAXAMNT ) 
						FROM	(
								SELECT		A.*
								FROM		(
											SELECT	* 
											FROM	PRD01..SOP10105 
											WHERE	LNITMSEQ <> 0
											) A
								INNER JOIN	(
											SELECT	* 
											FROM	PRD01..SOP10105 
											WHERE	LNITMSEQ = 0
											) B
									ON		A.SOPTYPE = B.SOPTYPE
									AND		A.SOPNUMBE = B.SOPNUMBE
									AND		A.TAXDTLID = B.TAXDTLID
								) SP105  
						WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
							AND SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND SP105.LNITMSEQ = SP303.LNITMSEQ 
							AND SP105.TAXDTLID IN	(
													'V-PARBA','V-PARBA 00','V-PARBA 01',
													'V-PARBA 02','V-PARBA 03','V-PARBA 04',
													'V-PARBA 05','V-PARBA 06','V-PARBA 07',
													'V-PARBA 08','V-PARBA 09','V-PARBA 10',
													'V-PARBA 11','V-PARBA 12','V-PARBA 13', 
													'V-PARBA 14','V-PARBA 15','V-PIIBB CF'
													) 
						) , 0 
					)													IMPVAL02
--		,	ISNULL	( 
--						( 
--						SELECT	SUM(SP105.STAXAMNT)  
--						FROM	PRD01..SOP10105 SP105 
--						WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
--							AND SP105.SOPNUMBE = SP303.SOPNUMBE 
--							AND SP105.LNITMSEQ = 0
--							AND SP105.TAXDTLID IN	(
--													'V-PARBA','V-PARBA 00','V-PARBA 01',
--													'V-PARBA 02','V-PARBA 03','V-PARBA 04',
--													'V-PARBA 05','V-PARBA 06','V-PARBA 07',
--													'V-PARBA 08','V-PARBA 09','V-PARBA 10',
--													'V-PARBA 11','V-PARBA 12','V-PARBA 13',     
--													'V-PARBA 14','V-PARBA 15','V-PIIBB CF'
--													) 
--						) , 0 
--					)													IMPVAL02
		,	'EXENTO'													IMPTIT03
		,	ISNULL	( 
						( 
						SELECT	SUM ( SP105.STAXAMNT ) 
						FROM	PRD01..SOP10105 SP105 
						WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
							AND SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND SP105.LNITMSEQ = SP303.LNITMSEQ 
							AND SP105.TAXDTLID IN ('V-IVA EXENTO') 
						) , 0 
					)													IMPVAL03
		,	SP302.SUBTOTAL												SUBTOTAL
		,	SP302.ORSUBTOT												ORSUBTOT
		,	SP302.TAXAMNT												TAXAMNT
		,	SP302.ORTAXAMT												ORTAXMNT
		,	SP302.DOCAMNT												DOCAMNT
		,	SP302.ORDOCAMT												ORDOCAMT
		,	SP302.CURNCYID												CURNCYID
		,	SP302.XCHGRATE												XCHGRATE
		,	LEFT(CONVERT(VARCHAR,SP302.XCHGRATE), LEN(CONVERT(VARCHAR,SP302.XCHGRATE))-4)	TCBIO
		,	RM101.COMMENT1												CURNCYIM
		,	CONVERT ( INT , SP402.COMMNTID )							CONTAFAC
		,	CONVERT(VARCHAR,SP302.DUEDATE,103)							DUEDATE
--		,	DYNAMICS.dbo.fncNUMLET (SP302.CURNCYID,SP302.DOCAMNT)		LETRAS
		,	CASE	WHEN RM101.COMMENT1 = 'ARS' 
						THEN	DYNAMICS.dbo.fncNUMLET (RM101.COMMENT1,SP302.DOCAMNT)	+ ' ---'	
					ELSE		'SON: ' + DYNAMICS.dbo.fncNUMLET (RM101.COMMENT1,SP302.ORDOCAMT)	+ ' ---'	
			END															LETRAS
----------------------------------
		,	CASE SUBSTRING(SP302.SOPNUMBE, 4, 1)
			WHEN 'A' THEN
				ISNULL	( 
						( 
						SELECT	SUM ( SP105.ORSLSTAX ) 
						FROM	PRD01..SOP10105 SP105 
						WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
							AND SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND SP105.LNITMSEQ = SP303.LNITMSEQ 
--							AND SP105.TAXDTLID IN ('V-IVA 21','V-IVA 10.5') 
							AND SP105.TAXDTLID IN ('V-IVA 21') 
						) , 0 
					) 
			ELSE		
				ISNULL	( 
						( 
						SELECT	SUM ( SP105.ORSLSTAX ) 
						FROM	PRD01..SOP10105 SP105 
						WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
							AND SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND SP105.LNITMSEQ = SP303.LNITMSEQ 
--							AND SP105.TAXDTLID IN ('V-IVA 21','V-IVA 10.5') 
							AND SP105.TAXDTLID IN ('V-IVA CONS FIN', 'V-IVA MONOT') 
						) , 0 
					) 
			END															IMPVAL04
		,	ISNULL	( 
						( 
						SELECT	SUM ( SP105.ORSLSTAX ) 
						FROM	(
								SELECT		A.*
								FROM		(
											SELECT	* 
											FROM	PRD01..SOP10105 
											WHERE	LNITMSEQ <> 0
											) A
								INNER JOIN	(
											SELECT	* 
											FROM	PRD01..SOP10105 
											WHERE	LNITMSEQ = 0
											) B
									ON		A.SOPTYPE = B.SOPTYPE
									AND		A.SOPNUMBE = B.SOPNUMBE
									AND		A.TAXDTLID = B.TAXDTLID
								) SP105 
						WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
							AND SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND SP105.LNITMSEQ = SP303.LNITMSEQ 
							AND SP105.TAXDTLID IN	(
													'V-PARBA','V-PARBA 00','V-PARBA 01',
													'V-PARBA 02','V-PARBA 03','V-PARBA 04',
													'V-PARBA 05','V-PARBA 06','V-PARBA 07',
													'V-PARBA 08','V-PARBA 09','V-PARBA 10',
													'V-PARBA 11','V-PARBA 12','V-PARBA 13',     
													'V-PARBA 14','V-PARBA 15','V-PIIBB CF'
													) 
						) , 0 
					)													IMPVAL05
--		,	ISNULL	( 
--						( 
--						SELECT	SUM(SP105.ORSLSTAX) 
--						FROM	PRD01..SOP10105 SP105 
--						WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
--							AND SP105.SOPNUMBE = SP303.SOPNUMBE 
--							AND SP105.LNITMSEQ = 0 
--							AND SP105.TAXDTLID IN	(
--													'V-PARBA','V-PARBA 00','V-PARBA 01',
--													'V-PARBA 02','V-PARBA 03','V-PARBA 04',
--													'V-PARBA 05','V-PARBA 06','V-PARBA 07',
--													'V-PARBA 08','V-PARBA 09','V-PARBA 10',
--													'V-PARBA 11','V-PARBA 12','V-PARBA 13',     
--													'V-PARBA 14','V-PARBA 15', 'V-PIIBB CF'
--													) 
--						) , 0 
--					)													IMPVAL05
		,	ISNULL	( 
						( 
						SELECT	SUM ( SP105.ORSLSTAX ) 
						FROM	PRD01..SOP10105 SP105 
						WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
							AND SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND SP105.LNITMSEQ = SP303.LNITMSEQ 
							AND SP105.TAXDTLID IN ('V-IVA EXENTO')
						) , 0 
					)													IMPVAL06
		,	RM102.ADDRESS3												ADDRESS3
		,	SP302.CSTPONBR												CSTPONBR
		,	0 /* ISNULL	( 
						( 
						SELECT	SUM ( SP105.STAXAMNT ) 
						FROM	PRD01..SOP10105 SP105 
						WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
							AND SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND SP105.LNITMSEQ = SP303.LNITMSEQ 
--							AND SP105.TAXDTLID IN ('V-IVA 21 DESG','V-IVA 10.5 DESG') 
							AND SP105.TAXDTLID IN ('V-IVA 21 DESG') 							
						) , 0 
					) 		*/											IMPVAL07
		,	0 /* ISNULL	( 
						( 
						SELECT	SUM ( SP105.ORSLSTAX ) 
						FROM	PRD01..SOP10105 SP105 
						WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
							AND SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND SP105.LNITMSEQ = SP303.LNITMSEQ 
--							AND SP105.TAXDTLID IN ('V-IVA 21 DESG','V-IVA 10.5 DESG') 
							AND SP105.TAXDTLID IN ('V-IVA 21 DESG') 
						) , 0 
					) 			*/										IMPVAL08
		,	ISNULL	( 
						( 
						SELECT		TX201.TXDTLPCT
						FROM		PRD01..SOP10105 SP105 
						INNER JOIN	PRD01..TX00201 TX201
							ON		SP105.TAXDTLID = TX201.TAXDTLID
						WHERE		SP105.SOPTYPE = SP303.SOPTYPE 
							AND		SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND		SP105.LNITMSEQ = SP303.LNITMSEQ 
							AND		SP105.TAXDTLID IN ('V-IVA 10.5') 
						) , 0 
					) 													IMPALIC01
		,	ISNULL	( 
						( 
						SELECT		TX201.TXDTLPCT
						FROM		PRD01..SOP10105 SP105 
						INNER JOIN	PRD01..TX00201 TX201
							ON		SP105.TAXDTLID = TX201.TAXDTLID
						WHERE		SP105.SOPTYPE = SP303.SOPTYPE 
							AND		SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND		SP105.LNITMSEQ = SP303.LNITMSEQ 
							AND		SP105.TAXDTLID IN ('V-IVA 21') 
						) , 0 
					) 													IMPALIC02
		,	ISNULL	( 
						( 
						SELECT		TX201.TXDTLPCT
						FROM		PRD01..SOP10105 SP105 
						INNER JOIN	PRD01..TX00201 TX201
							ON		SP105.TAXDTLID = TX201.TAXDTLID
						WHERE		SP105.SOPTYPE = SP303.SOPTYPE 
							AND		SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND		SP105.LNITMSEQ = SP303.LNITMSEQ 
							AND		SP105.TAXDTLID IN ('V-IVA 10.5 DESG') 
						) , 0 
					) 													IMPALIC03
		,	0 /*ISNULL	( 
						( 
						SELECT		TX201.TXDTLPCT
						FROM		PRD01..SOP10105 SP105 
						INNER JOIN	PRD01..TX00201 TX201
							ON		SP105.TAXDTLID = TX201.TAXDTLID
						WHERE		SP105.SOPTYPE = SP303.SOPTYPE 
							AND		SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND		SP105.LNITMSEQ = SP303.LNITMSEQ 
							AND		SP105.TAXDTLID IN ('V-IVA 21 DESG') 
						) , 0 
					) 			*/										IMPALIC04
		,LTRIM(CONVERT(VARCHAR,DYNAMICS.dbo.fncPERCENT(SP302.TRDISPCT))) + ' ' + CHAR(37)				TRDISPCT
		,ISNULL	( 
					( 
					SELECT	SUM ( SP105.STAXAMNT ) 
					FROM	PRD01..SOP10105 SP105 
					WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
						AND SP105.SOPNUMBE = SP303.SOPNUMBE 
						AND SP105.LNITMSEQ = SP303.LNITMSEQ 
						AND SP105.TAXDTLID IN ('V-IVA 10.5') 
					) , 0 
				) 													IMPVAL09
		,ISNULL	( 
					( 
					SELECT	SUM ( SP105.ORSLSTAX ) 
					FROM	PRD01..SOP10105 SP105 
					WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
						AND SP105.SOPNUMBE = SP303.SOPNUMBE 
						AND SP105.LNITMSEQ = SP303.LNITMSEQ 
						AND SP105.TAXDTLID IN ('V-IVA 10.5') 
					) , 0 
				) 													IMPVAL10
		,ISNULL	( 
					( 
					SELECT	SUM ( SP105.STAXAMNT ) 
					FROM	PRD01..SOP10105 SP105 
					WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
						AND SP105.SOPNUMBE = SP303.SOPNUMBE 
						AND SP105.LNITMSEQ = SP303.LNITMSEQ 
						AND SP105.TAXDTLID IN ('V-IVA 10.5 DESG') 
					) , 0 
				) 													IMPVAL11
		,ISNULL	( 
					( 
					SELECT	SUM ( SP105.ORSLSTAX ) 
					FROM	PRD01..SOP10105 SP105 
					WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
						AND SP105.SOPNUMBE = SP303.SOPNUMBE 
						AND SP105.LNITMSEQ = SP303.LNITMSEQ 
						AND SP105.TAXDTLID IN ('V-IVA 10.5 DESG') 
					) , 0 
				) 													IMPVAL12
		,	(
			ISNULL(LTRIM(RTRIM(SP106.USERDEF1)), '') + ' ' +
			ISNULL(LTRIM(RTRIM(SP106.USERDEF2)), '') + ' ' +
			ISNULL(LTRIM(RTRIM(SP106.USRDEF03)), '') + ' ' +
			ISNULL(LTRIM(RTRIM(SP106.USRDEF04)), '') + ' ' +
			ISNULL(LTRIM(RTRIM(SP106.USRDEF05)), '')
			)															OBSERVACIONES
		,	RM101.USERDEF1											PROVEEDORNRO
		,	ISNULL(FRG.FRG_CAE, ISNULL(FEI_CAE, '111111111111'))     			CAE
		,	ISNULL(FRG.FRG_CAE_DUE, ISNULL(FEI_CAE_DUE, convert(datetime, 0)) )			VENCCAE
		,	isnull(FRG.FRG_LETRA1,isnull( FEI_LETRA1,'Z'))								LETRA
		,	isnull(FRG.FRG_PDV,isnull(FEI_PDV, '000'))									PDV
		,	isnull(FRG.FRG_COD,isnull( FEI_COD,'1111111111'))									CODCOMP
		,	isnull(FRG.FRG_MOTIVO, '')								MOTIVO
		,	isnull(FRG.FRG_NRO,isnull(FEI_NRO, '1111111111'))									NUMERO
		,	(SELECT LEFT(TAXREGTN, 11) FROM DYNAMICS..SY01500 
			WHERE INTERID = 'PRD01')								CUITCOMP
		,	SP303.MRKDNPCT											MRKDNPCT
		,	ISNULL((SELECT TOP 1 SERLTNUM
			FROM PRD01..SOP10201 SP102 WHERE SP102.SOPTYPE						=	SP303.SOPTYPE
			AND	SP102.SOPNUMBE						=	SP303.SOPNUMBE
			AND	SP102.LNITMSEQ						=	SP303.LNITMSEQ
			AND SP102.CMPNTSEQ						=	SP303.CMPNTSEQ), '') DESPACHO
		,	CASE WHEN RTRIM(RM101.COMMENT1) = 'ARS' THEN 
				ISNULL	( 
						( 
						SELECT	SUM(SP105.STAXAMNT )
						FROM	PRD01..SOP10105 SP105 
						WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
							AND SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND SP105.LNITMSEQ = 0
							AND SP105.TAXDTLID IN ('V-IVA 21', 'V-IVA CONS FIN', 'V-IVA MONOT') 
						) , 0 
					) 													
			ELSE	
				ISNULL	( 
						( 
						SELECT	SUM(SP105.ORSLSTAX )
						FROM	PRD01..SOP10105 SP105 
						WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
							AND SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND SP105.LNITMSEQ = 0
							AND SP105.TAXDTLID IN ('V-IVA 21', 'V-IVA CONS FIN', 'V-IVA MONOT') 
						) , 0 
					) 			END										IVA21
		,	CASE WHEN RTRIM(RM101.COMMENT1) = 'ARS' THEN 
				ISNULL	( 
					( 
					SELECT	SUM ( SP105.STAXAMNT ) 
					FROM	PRD01..SOP10105 SP105 
					WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
						AND SP105.SOPNUMBE = SP303.SOPNUMBE 
						AND SP105.LNITMSEQ = 0 
						AND SP105.TAXDTLID IN ('V-IVA 10.5') 
					) , 0 
				) 													
			ELSE
				ISNULL	( 
					( 
					SELECT	SUM ( SP105.ORSLSTAX ) 
					FROM	PRD01..SOP10105 SP105 
					WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
						AND SP105.SOPNUMBE = SP303.SOPNUMBE 
						AND SP105.LNITMSEQ = 0 
						AND SP105.TAXDTLID IN ('V-IVA 10.5') 
					) , 0 
				) 				END										IVA105
		,	CASE WHEN RTRIM(RM101.COMMENT1) = 'ARS' THEN 
				ISNULL	( 
						( 
						SELECT	SUM ( SP105.STAXAMNT ) 
						FROM	PRD01..SOP10105 SP105
						WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
							AND SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND SP105.LNITMSEQ = 0 
							AND SP105.TAXDTLID IN	(
													'V-PARBA','V-PARBA 00','V-PARBA 01',
													'V-PARBA 02','V-PARBA 03','V-PARBA 04',
													'V-PARBA 05','V-PARBA 06','V-PARBA 07',
													'V-PARBA 08','V-PARBA 09','V-PARBA 10',
													'V-PARBA 11','V-PARBA 12','V-PARBA 13',     
													'V-PARBA 14','V-PARBA 15','V-PIIBB CF'
													) 
 
						) , 0 
					)	
			ELSE
				ISNULL	( 
						( 
						SELECT	SUM ( SP105.ORSLSTAX ) 
						FROM	PRD01..SOP10105 SP105
						WHERE	SP105.SOPTYPE = SP303.SOPTYPE 
							AND SP105.SOPNUMBE = SP303.SOPNUMBE 
							AND SP105.LNITMSEQ = 0 
							AND SP105.TAXDTLID IN	(
													'V-PARBA','V-PARBA 00','V-PARBA 01',
													'V-PARBA 02','V-PARBA 03','V-PARBA 04',
													'V-PARBA 05','V-PARBA 06','V-PARBA 07',
													'V-PARBA 08','V-PARBA 09','V-PARBA 10',
													'V-PARBA 11','V-PARBA 12','V-PARBA 13',     
													'V-PARBA 14','V-PARBA 15','V-PIIBB CF'
													) 
 
						) , 0 
					)			END 						PRCIIBB
		,	SP302.CNTCPRSN									CONTACTO													
			
					
----------------------------------
	
		FROM PRD01..SOP30200							SP302
		     INNER JOIN	PRD01..SOP30300	SP303	ON	SP303.SOPTYPE						=	SP302.SOPTYPE
		AND	SP303.SOPNUMBE						=	SP302.SOPNUMBE
--		INNER JOIN
		LEFT OUTER JOIN
			PRD01..IV00101							IV101
		ON
--			IV101.ITEMNMBR						=	SP102.ITEMNMBR
			IV101.ITEMNMBR						=	SP303.ITEMNMBR
--		INNER JOIN
--			PRD01..IV00301							IV301
--		ON
--			IV301.ITEMNMBR						=	SP102.ITEMNMBR
--		AND	IV301.LOTNUMBR						=	SP102.SERLTNUM
		INNER JOIN
			PRD01..RM00101							RM101
		ON
			RM101.CUSTNMBR						=	SP302.CUSTNMBR
		AND	RM101.COMMENT1						IN	('ARS' , 'DOL', 'EUR')
		INNER JOIN
			PRD01..SOP40200							SP402
		ON
			SP402.DOCID						=	SP302.DOCID
		LEFT OUTER JOIN
			PRD01..SOP10106							SP106
		ON
			SP302.SOPTYPE						=	SP106.SOPTYPE
		AND	SP302.SOPNUMBE						=	SP106.SOPNUMBE
		INNER JOIN
			PRD01..RM00102							RM102
		ON
			SP302.CUSTNMBR						=	RM102.CUSTNMBR
		AND	SP302.PRBTADCD						=	RM102.ADRSCODE
		LEFT OUTER JOIN
			PRD01..FRG_RM20101						FRG
		ON
			CASE SP302.SOPTYPE 
			WHEN 3 THEN 1 ELSE 8 END			=	FRG.RMDTYPAL
		AND	SP302.SOPNUMBE						=	FRG.DOCNUMBR
	    LEFT OUTER JOIN
			PRD01..FEI_SOP30200 AS FEI	ON SP302.SOPTYPE	= FEI.SOPTYPE AND SP302.SOPNUMBE  = FEI.SOPNUMBE
		WHERE
			SP302.SOPTYPE						IN	( 3 , 4 )
		--AND	SP302.SOPNUMBE						BETWEEN	@SOPNUMBED AND @SOPNUMBEH
		AND	SP302.VOIDSTTS						=	0
		AND SP303.QUANTITY						<>	0
	--	ORDER BY								SP302.SOPTYPE
	--,										SP302.SOPNUMBE
	--,										SP303.LNITMSEQ



GO


